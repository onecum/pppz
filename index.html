<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Система учёта ПВЗ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .tg-button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .tg-button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Упрощенный Telegram WebApp API
        const createTelegramAPI = () => {
            const isTelegram = window.Telegram?.WebApp;
            
            if (isTelegram) {
                try {
                    window.Telegram.WebApp.ready();
                    window.Telegram.WebApp.expand();
                    return window.Telegram.WebApp;
                } catch (e) {
                    console.warn('Telegram API error:', e);
                }
            }
            
            // Fallback для браузера
            return {
                ready: () => {},
                expand: () => {},
                CloudStorage: {
                    getItem: (key, callback) => {
                        setTimeout(() => {
                            try {
                                callback(null, localStorage.getItem(key));
                            } catch (e) {
                                callback(e, null);
                            }
                        }, 0);
                    },
                    setItem: (key, value, callback) => {
                        setTimeout(() => {
                            try {
                                localStorage.setItem(key, value);
                                callback(null, true);
                            } catch (e) {
                                callback(e, false);
                            }
                        }, 0);
                    }
                },
                initDataUnsafe: { user: null },
                BackButton: {
                    show: () => {},
                    hide: () => {},
                    onClick: (fn) => { window._tgBackHandler = fn; },
                    offClick: () => { window._tgBackHandler = null; }
                },
                MainButton: {
                    setText: () => {},
                    show: () => {},
                    hide: () => {},
                    onClick: (fn) => { window._tgMainHandler = fn; },
                    offClick: () => { window._tgMainHandler = null; }
                },
                showAlert: (msg) => alert(msg),
                showConfirm: (msg, callback) => callback(confirm(msg)),
                HapticFeedback: {
                    notificationOccurred: () => {}
                }
            };
        };

        const tg = createTelegramAPI();

        // Hook для работы с хранилищем
        const useStorage = (key, initialValue) => {
            const [data, setData] = useState(initialValue);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                tg.CloudStorage.getItem(key, (error, value) => {
                    if (!error && value) {
                        try {
                            setData(JSON.parse(value));
                        } catch (e) {
                            setData(initialValue);
                        }
                    }
                    setLoading(false);
                });
            }, [key]);

            const updateData = useCallback((newData) => {
                const str = JSON.stringify(newData);
                tg.CloudStorage.setItem(key, str, (error) => {
                    if (!error) {
                        setData(newData);
                    }
                });
            }, [key]);

            return [data, updateData, loading];
        };

        // Иконки (простые SVG)
        const PlusIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const TrashIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        );

        const MenuIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        );

        const CheckIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        );

        const OrderManagementSystem = () => {
            const user = tg.initDataUnsafe?.user;
            const userName = user?.first_name || 'Пользователь';
            
            const [pvzList, setPvzList, pvzLoading] = useStorage('pvzList', []);
            const [orders, setOrders, ordersLoading] = useStorage('orders', {});
            const [isUnlocked, setIsUnlocked] = useState(false);
            const [password, setPassword] = useState('');
            const [showMenu, setShowMenu] = useState(false);
            const [showOrderForm, setShowOrderForm] = useState(false);
            const [currentView, setCurrentView] = useState('main');
            const [selectedDate, setSelectedDate] = useState(new Date());
            
            const [newOrder, setNewOrder] = useState({
                pvzId: '',
                orderNumber: '',
                customer: '',
                model: '',
                amount: 0
            });

            // Настройка Back Button
            useEffect(() => {
                if (showOrderForm || currentView !== 'main') {
                    tg.BackButton.show();
                    tg.BackButton.onClick(() => {
                        if (showOrderForm) {
                            setShowOrderForm(false);
                        } else {
                            setCurrentView('main');
                        }
                    });
                } else {
                    tg.BackButton.hide();
                }
                
                return () => tg.BackButton.offClick();
            }, [showOrderForm, currentView]);

            const handleLogin = () => {
                if (password === '6556') {
                    setIsUnlocked(true);
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    tg.showAlert('Неверный пароль!');
                    tg.HapticFeedback.notificationOccurred('error');
                }
            };

            const handleAddOrder = () => {
                if (!newOrder.pvzId || !newOrder.orderNumber) {
                    tg.showAlert('Заполните обязательные поля');
                    return;
                }

                const order = {
                    id: Date.now(),
                    ...newOrder,
                    createdAt: new Date().toISOString(),
                    createdBy: userName,
                    status: 'В пути',
                    delivered: false
                };

                const pvzOrders = orders[newOrder.pvzId] || [];
                const updatedOrders = {
                    ...orders,
                    [newOrder.pvzId]: [...pvzOrders, order]
                };

                setOrders(updatedOrders);
                setShowOrderForm(false);
                setNewOrder({ pvzId: '', orderNumber: '', customer: '', model: '', amount: 0 });
                
                tg.showAlert('Заказ добавлен!');
                tg.HapticFeedback.notificationOccurred('success');
            };

            const handleMarkDelivered = (pvzId, orderId) => {
                const updatedOrders = {
                    ...orders,
                    [pvzId]: orders[pvzId].map(o => 
                        o.id === orderId 
                            ? { ...o, delivered: true, deliveredAt: new Date().toISOString(), deliveredBy: userName }
                            : o
                    )
                };
                setOrders(updatedOrders);
                tg.HapticFeedback.notificationOccurred('success');
            };

            const handleDeleteOrder = (pvzId, orderId) => {
                tg.showConfirm('Удалить заказ?', (confirmed) => {
                    if (confirmed) {
                        const updatedOrders = {
                            ...orders,
                            [pvzId]: orders[pvzId].filter(o => o.id !== orderId)
                        };
                        setOrders(updatedOrders);
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                });
            };

            const addSamplePVZ = () => {
                if (pvzList.length === 0) {
                    setPvzList([
                        { id: 1, address: 'ул. Ленина, 1' },
                        { id: 2, address: 'пр. Мира, 25' },
                        { id: 3, address: 'ул. Гагарина, 10' }
                    ]);
                    tg.showAlert('Добавлены тестовые ПВЗ');
                }
            };

            // Экран входа
            if (!isUnlocked) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-purple-50 to-blue-50">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                            <div className="text-center mb-6">
                                <div className="w-20 h-20 bg-gradient-to-br from-purple-500 to-blue-500 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-3xl">
                                    🔐
                                </div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">Система ПВЗ</h1>
                                <p className="text-gray-600">Введите пароль для входа</p>
                            </div>
                            <div className="space-y-4">
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                    placeholder="Пароль"
                                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg"
                                />
                                <button
                                    onClick={handleLogin}
                                    className="w-full py-3 rounded-xl font-semibold text-white tg-button transition-all"
                                >
                                    Войти
                                </button>
                                <div className="text-center text-sm text-gray-500 mt-4">
                                    👤 {userName}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Загрузка
            if (pvzLoading || ordersLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-4 border-purple-500 border-t-transparent mx-auto mb-4"></div>
                            <p className="text-gray-600 text-lg">Загрузка данных...</p>
                        </div>
                    </div>
                );
            }

            // Форма добавления заказа
            if (showOrderForm) {
                return (
                    <div className="min-h-screen bg-gray-50 p-4">
                        <div className="max-w-2xl mx-auto">
                            <h2 className="text-2xl font-bold mb-6 text-gray-800">Новый заказ</h2>
                            
                            <div className="bg-white rounded-2xl shadow-lg p-6 space-y-4">
                                <div>
                                    <label className="block text-sm font-semibold mb-2 text-gray-700">ПВЗ *</label>
                                    <select
                                        value={newOrder.pvzId}
                                        onChange={(e) => setNewOrder({...newOrder, pvzId: e.target.value})}
                                        className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                    >
                                        <option value="">Выберите ПВЗ</option>
                                        {pvzList.map(pvz => (
                                            <option key={pvz.id} value={pvz.id}>{pvz.address}</option>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold mb-2 text-gray-700">Номер заказа *</label>
                                    <input
                                        type="text"
                                        value={newOrder.orderNumber}
                                        onChange={(e) => setNewOrder({...newOrder, orderNumber: e.target.value})}
                                        className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                        placeholder="Введите номер"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold mb-2 text-gray-700">Покупатель</label>
                                    <input
                                        type="text"
                                        value={newOrder.customer}
                                        onChange={(e) => setNewOrder({...newOrder, customer: e.target.value})}
                                        className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                        placeholder="ФИО"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold mb-2 text-gray-700">Модель</label>
                                    <input
                                        type="text"
                                        value={newOrder.model}
                                        onChange={(e) => setNewOrder({...newOrder, model: e.target.value})}
                                        className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                        placeholder="iPhone 16 Pro Max"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold mb-2 text-gray-700">Сумма (₽)</label>
                                    <input
                                        type="number"
                                        value={newOrder.amount}
                                        onChange={(e) => setNewOrder({...newOrder, amount: parseFloat(e.target.value) || 0})}
                                        className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                        placeholder="0"
                                    />
                                </div>

                                <div className="flex gap-3 pt-4">
                                    <button
                                        onClick={() => setShowOrderForm(false)}
                                        className="flex-1 px-6 py-3 bg-gray-200 text-gray-800 rounded-xl font-semibold hover:bg-gray-300 transition-all"
                                    >
                                        Отмена
                                    </button>
                                    <button
                                        onClick={handleAddOrder}
                                        className="flex-1 px-6 py-3 rounded-xl font-semibold text-white tg-button transition-all"
                                    >
                                        Добавить
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Главный экран
            const todayOrders = Object.values(orders).flat();

            return (
                <div className="min-h-screen bg-gray-50 pb-20">
                    {/* Заголовок */}
                    <div className="sticky top-0 z-10 bg-white shadow-sm">
                        <div className="p-4">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-800">Система ПВЗ</h1>
                                    <p className="text-sm text-gray-600">👤 {userName}</p>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setShowOrderForm(true)}
                                        className="p-3 tg-button rounded-xl shadow-lg hover:shadow-xl transition-all"
                                    >
                                        <PlusIcon />
                                    </button>
                                    <button
                                        onClick={() => setShowMenu(!showMenu)}
                                        className="p-3 bg-gray-200 rounded-xl hover:bg-gray-300 transition-all"
                                    >
                                        <MenuIcon />
                                    </button>
                                </div>
                            </div>
                            
                            <div className="flex items-center justify-between text-sm text-gray-600 bg-purple-50 rounded-xl p-3">
                                <span>📦 Всего заказов: {todayOrders.length}</span>
                                <span>✅ Доставлено: {todayOrders.filter(o => o.delivered).length}</span>
                            </div>
                        </div>
                    </div>

                    {/* Список заказов */}
                    <div className="p-4 space-y-4">
                        {pvzList.length === 0 ? (
                            <div className="text-center py-12">
                                <div className="text-6xl mb-4">📦</div>
                                <p className="text-gray-600 mb-4">Нет ПВЗ в системе</p>
                                <button
                                    onClick={addSamplePVZ}
                                    className="px-6 py-3 tg-button rounded-xl font-semibold text-white"
                                >
                                    Добавить тестовые ПВЗ
                                </button>
                            </div>
                        ) : (
                            pvzList.map(pvz => {
                                const pvzOrders = orders[pvz.id] || [];
                                
                                return (
                                    <div key={pvz.id} className="bg-white rounded-2xl shadow-lg overflow-hidden">
                                        <div className="bg-gradient-to-r from-purple-500 to-blue-500 p-4 text-white">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <div className="font-bold text-lg">{pvz.address}</div>
                                                    <div className="text-sm opacity-90">{pvzOrders.length} заказов</div>
                                                </div>
                                                <div className="text-3xl">📍</div>
                                            </div>
                                        </div>

                                        {pvzOrders.length === 0 ? (
                                            <div className="p-6 text-center text-gray-500">
                                                Нет заказов
                                            </div>
                                        ) : (
                                            <div className="divide-y divide-gray-100">
                                                {pvzOrders.map(order => (
                                                    <div key={order.id} className="p-4 hover:bg-gray-50 transition-colors">
                                                        <div className="flex items-start justify-between mb-3">
                                                            <div className="flex-1">
                                                                <div className="font-bold text-gray-900 text-lg">
                                                                    #{order.orderNumber}
                                                                </div>
                                                                {order.customer && (
                                                                    <div className="text-sm text-gray-600 mt-1">
                                                                        👤 {order.customer}
                                                                    </div>
                                                                )}
                                                                {order.model && (
                                                                    <div className="text-sm text-gray-600 mt-1">
                                                                        📱 {order.model}
                                                                    </div>
                                                                )}
                                                                {order.amount > 0 && (
                                                                    <div className="text-sm font-bold text-green-600 mt-1">
                                                                        {order.amount.toLocaleString('ru-RU')} ₽
                                                                    </div>
                                                                )}
                                                            </div>

                                                            <div className={`px-4 py-2 rounded-xl text-sm font-bold ${
                                                                order.delivered 
                                                                    ? 'bg-green-100 text-green-700'
                                                                    : 'bg-yellow-100 text-yellow-700'
                                                            }`}>
                                                                {order.delivered ? '✓ Доставлено' : '⏱ В пути'}
                                                            </div>
                                                        </div>

                                                        <div className="flex gap-2 mt-3">
                                                            {!order.delivered && (
                                                                <button
                                                                    onClick={() => handleMarkDelivered(pvz.id, order.id)}
                                                                    className="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-xl font-semibold transition-all flex items-center justify-center gap-2"
                                                                >
                                                                    <CheckIcon /> Доставлено
                                                                </button>
                                                            )}
                                                            <button
                                                                onClick={() => handleDeleteOrder(pvz.id, order.id)}
                                                                className="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-xl font-semibold transition-all"
                                                            >
                                                                <TrashIcon />
                                                            </button>
                                                        </div>

                                                        {order.createdBy && (
                                                            <div className="text-xs text-gray-500 mt-2">
                                                                Добавил: {order.createdBy}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                );
                            })
                        )}
                    </div>

                    {/* Меню */}
                    {showMenu && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end" onClick={() => setShowMenu(false)}>
                            <div className="bg-white w-full rounded-t-3xl p-6" onClick={(e) => e.stopPropagation()}>
                                <div className="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-6"></div>
                                <h3 className="font-bold text-xl mb-4">Меню</h3>
                                <div className="space-y-2">
                                    <button
                                        onClick={() => {
                                            setCurrentView('settings');
                                            setShowMenu(false);
                                        }}
                                        className="w-full text-left px-4 py-3 hover:bg-gray-100 rounded-xl transition-all"
                                    >
                                        ⚙️ Настройки
                                    </button>
                                    <button
                                        onClick={() => {
                                            setCurrentView('stats');
                                            setShowMenu(false);
                                        }}
                                        className="w-full text-left px-4 py-3 hover:bg-gray-100 rounded-xl transition-all"
                                    >
                                        📊 Статистика
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<OrderManagementSystem />, document.getElementById('root'));
    </script>

    <script>
        // Загрузка Telegram WebApp SDK (опционально)
        (function() {
            const script = document.createElement('script');
            script.src = 'https://telegram.org/js/telegram-web-app.js';
            script.async = true;
            document.head.appendChild(script);
        })();
    </script>
</body>
</html>
